<!DOCTYPE html>
<html>

<head>
    <title>Quiz</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        body {
            background: #232946;
            color: #fff;
        }

        .quiz-container {
            max-width: 700px;
            margin: 2rem auto;
            background: #fff;
            color: #232946;
            border-radius: 14px;
            box-shadow: 0 4px 24px rgba(0, 198, 255, 0.08);
            padding: 2rem 2rem 1.5rem 2rem;
        }

        #timerContainer {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        #timerClock {
            font-size: 1.3rem;
            color: #ff4d4d;
            font-weight: bold;
        }

        .quiz-question {
            background: #f4f6fb;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 198, 255, 0.07);
            padding: 1.2rem 1rem 1rem 1rem;
            margin-bottom: 1.5rem;
            transition: box-shadow 0.2s;
        }

        .quiz-question:hover {
            box-shadow: 0 4px 16px #00c6ff44;
        }

        .btn-3d {
            background: linear-gradient(120deg, #00c6ff 0%, #007bff 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px 24px;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 1rem;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.08);
        }

        .btn-3d:hover {
            background: linear-gradient(120deg, #007bff 0%, #00c6ff 100%);
        }
    </style>
</head>

<body oncontextmenu="return false;">
    <div class="quiz-container">
        <h2 id="quizTitle"></h2>
        <div id="timerContainer">
            <span id="timerClock"></span>
        </div>
        <form id="quizForm">
            <div id="questionsContainer"></div>
            <button type="button" class="btn-3d" onclick="submitQuiz()">Submit Quiz</button>
        </form>
        <div id="quizMsg" style="margin-top:1.2rem;font-weight:bold;"></div>
        <button id="backToQuizList" class="btn-3d" style="display:none;margin-top:1.2rem;" onclick="goBackToQuizList()">&#8592; Back to Quiz List</button>
    </div>
    <script>
        let quizTimerInterval;
        let quizTimeLeft = 60;
        let currentQuiz = null;

        window.onload = loadQuizzes;

        async function loadQuizzes() {
            const res = await fetch('/api/quizzes');
            const quizzes = await res.json();
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            const quizList = document.createElement('div');
            quizList.style.textAlign = 'center';
            quizList.innerHTML = '<h3>Select a Quiz</h3>';
            quizzes.forEach((quiz, idx) => {
                const button = document.createElement('button');
                button.textContent = quiz.title;
                button.className = 'btn-3d';
                button.style.minWidth = '180px';
                button.style.fontSize = '1.1rem';
                button.style.margin = '0.5rem 0';
                button.onclick = () => loadQuiz(quiz);
                quizList.appendChild(button);
            });
            container.appendChild(quizList);
            document.getElementById('quizTitle').textContent = '';
            document.getElementById('timerClock').textContent = '';
        }

        async function loadQuiz(quiz) {
            clearInterval(quizTimerInterval);
            currentQuiz = quiz;
            document.getElementById('quizTitle').textContent = quiz.title;
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            quiz.questions.forEach((question, idx) => {
                const div = document.createElement('div');
                div.className = 'quiz-question';
                div.innerHTML = `
                    <p style="font-size:1.15rem;color:#007bff;font-weight:600;">Q${idx+1}. ${question.question}</p>
                    <div style="margin-top:0.7rem;">
                    ${question.options.map((opt, i) =>
                        `<label style='display:block;margin-bottom:0.5rem;cursor:pointer;color:#232946;font-size:1rem;'><input type="radio" name="q${idx}" value="${opt}" style="margin-right:8px;"> ${opt}</label>`
                    ).join('')}
                    </div>
                `;
                container.appendChild(div);
            });
            container.dataset.correctAnswers = JSON.stringify(quiz.questions.map(q => q.correct));
            // Timer logic
            quizTimeLeft = parseInt(quiz.timer) || 60;
            document.getElementById('timerClock').textContent = `Time Left: ${quizTimeLeft}s`;
            quizTimerInterval = setInterval(() => {
                quizTimeLeft--;
                document.getElementById('timerClock').textContent = `Time Left: ${quizTimeLeft}s`;
                if (quizTimeLeft <= 0) {
                    clearInterval(quizTimerInterval);
                    document.getElementById('timerClock').textContent = "Time's up!";
                    submitQuiz();
                }
            }, 1000);
        }

        async function submitQuiz() {
            clearInterval(quizTimerInterval);
            const form = document.getElementById('quizForm');
            const answers = [];
            const questions = document.querySelectorAll('.quiz-question');
            const correctAnswers = JSON.parse(document.getElementById('questionsContainer').dataset.correctAnswers);
            let correctCount = 0;
            questions.forEach((qDiv, idx) => {
                const selected = form.querySelector(`input[name="q${idx}"]:checked`);
                const answer = selected ? selected.value : null;
                answers.push(answer);
                if (answer === correctAnswers[idx]) {
                    correctCount++;
                }
            });
            // Fetch username from backend (session)
            let username = "";
            try {
                const userRes = await fetch('/api/user');
                if (userRes.ok) {
                    const userData = await userRes.json();
                    username = userData.username || "";
                }
            } catch (e) {}
            const quizTitle = document.getElementById('quizTitle').textContent;
            const timestamp = new Date().toISOString();
            const res = await fetch('/api/performance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: username,
                    quiz_title: quizTitle,
                    answers: answers,
                    correctCount: correctCount,
                    submitted_at: timestamp
                })
            });
            const data = await res.json();
            document.getElementById('quizMsg').textContent = data.msg;
            if (res.status === 201) {
                document.getElementById('quizMsg').style.color = 'limegreen';
            } else {
                document.getElementById('quizMsg').style.color = 'red';
            }
            // Show back button after submission
            document.getElementById('backToQuizList').style.display = 'inline-block';
        }

        function goBackToQuizList() {
            // Reset UI to quiz list
            document.getElementById('quizForm').style.display = 'block';
            document.getElementById('quizMsg').textContent = '';
            document.getElementById('backToQuizList').style.display = 'none';
            loadQuizzes();
        }
    </script>
</body>

</html>